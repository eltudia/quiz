<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
<<<<<<< HEAD
  <title>Excel'den ƒ∞ngilizce Quiz</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; max-width: 760px; }
    .card { border: 1px solid #e5e5e5; border-radius: 14px; padding: 16px; margin: 12px 0; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    button:hover { background: #fafafa; }
    .choices { display: grid; gap: 10px; margin-top: 12px; }
    .choice { text-align: left; padding: 12px; }
    .choice:disabled { cursor: default; opacity: 0.95; }

    .choice.correct { background: #e7f7ec; border-color: #2e7d32; }
    .choice.wrong   { background: #fdecea; border-color: #c62828; }

    .ok { color: #0a7a2f; font-weight: 700; }
    .bad { color: #b00020; font-weight: 700; }
    .muted { color: #666; font-size: 14px; }

    input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; }
    select { padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
    .pill { display:inline-block; padding:6px 10px; border:1px solid #eee; border-radius:999px; font-size:13px; color:#555; }
    .divider { height: 1px; background: #eee; margin: 12px 0; }

    .diffline { font-size: 18px; line-height: 1.7; }
    .goodChar { background: #e7f7ec; border: 1px solid #b7e3c3; border-radius: 6px; padding: 0 4px; }
    .badChar  { background: #fdecea; border: 1px solid #f2b8b5; border-radius: 6px; padding: 0 4px; }
    .missChar { background: #fff6d6; border: 1px solid #f0e1a2; border-radius: 6px; padding: 0 4px; }
    .spaceChar{ display:inline-block; min-width: 10px; }
    .legend { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .tag { font-size: 12px; border:1px solid #eee; border-radius:999px; padding:4px 8px; color:#555; }
  </style>
</head>
<body>
  <h2>Excel'den Quiz</h2>

  <div class="card">
    <div class="row">
      <input id="file" type="file" accept=".xlsx,.xls" />
      <span class="muted">Excel‚Äôi se√ß ‚Üí i√ßerik y√ºklenir</span>
    </div>

    <div class="row" style="margin-top:12px">
      <label>Mod:</label>
      <select id="direction">
        <option value="EN_TR">English ‚Üí T√ºrk√ße (≈ûƒ±klƒ± + Ses)</option>
        <option value="TR_EN">T√ºrk√ße ‚Üí English (Yazmalƒ± + Hata G√∂ster)</option>
      </select>

      <label>Quiz kaynaƒüƒ±:</label>
      <select id="sourceMode">
        <option value="ALL">T√ºm sorular</option>
        <option value="WRONG_ONLY">‚ùå Sadece yanlƒ±≈ülar</option>
      </select>
    </div>

    <div class="muted" style="margin-top:10px">
      Kƒ±sayollar: <b>‚Üí</b> sonraki ‚Ä¢ <b>1-4</b> ≈üƒ±k se√ß (EN‚ÜíTR) ‚Ä¢ <b>Enter</b> kontrol (TR‚ÜíEN) ‚Ä¢ <b>‚Üì</b> veya <b>Ctrl+Space</b> cevabƒ± g√∂ster
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div><b>Skor:</b> <span id="score">0</span> doƒüru / <span id="total">0</span> soru</div>
      <span class="pill">Yanlƒ±≈ü havuzu: <b id="wrongCount">0</b></span>
      <span class="pill">Kaynak: <b id="poolLabel">T√ºm sorular</b></span>
      <span class="pill">Mod: <b id="modeLabel">EN‚ÜíTR</b></span>
    </div>
  </div>

  <div id="quiz" class="card" style="display:none">
    <div class="muted" id="meta"></div>
    <h3 id="prompt" style="margin: 8px 0 0 0;"></h3>

    <!-- EN‚ÜíTR: 4 ≈üƒ±klƒ± -->
    <div id="mcq" style="display:none">
      <div class="choices" id="choices"></div>
    </div>

    <!-- TR‚ÜíEN: yazmalƒ± -->
    <div id="typing" style="display:none; margin-top:12px">
      <input id="answerInput" type="text" placeholder="ƒ∞ngilizce kar≈üƒ±lƒ±ƒüƒ±nƒ± yaz... (bo≈üluk serbest)" />
      <div class="row" style="margin-top:10px">
        <button id="check">Kontrol Et</button>
        <button id="show">Cevabƒ± G√∂ster</button>
      </div>
      <div class="legend">
        <span class="tag">üü© Doƒüru harf</span>
        <span class="tag">üü• Yanlƒ±≈ü harf</span>
        <span class="tag">üü® Eksik harf</span>
      </div>
    </div>

    <div id="feedback" style="margin-top:12px"></div>

    <div class="divider"></div>

    <div class="row" style="justify-content:center; gap:12px;">
      <button id="start" disabled>Ba≈ülat</button>
      <button id="next" disabled>Sonraki</button>
      <button id="reset" disabled>Sƒ±fƒ±rla</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // -------- State --------
    let pairs = [];
    let wrongIds = new Set();
    let wrongList = [];
    let current = null; // {id,en,tr,mode,prompt,answer}
    let score = 0;
    let total = 0;
=======
  <title>English Quiz ‚Ä¢ Excel‚Äôden</title>
  <style>
    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,.08);
      --panel2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --muted2: rgba(255,255,255,.45);
      --good: #26d07c;
      --bad: #ff4d6d;
      --accent: #7c5cff;
      --accent2: #2ee6d6;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(124,92,255,.35), transparent 60%),
        radial-gradient(900px 500px at 85% 25%, rgba(46,230,214,.25), transparent 55%),
        radial-gradient(900px 600px at 50% 110%, rgba(255,77,109,.18), transparent 55%),
        linear-gradient(180deg, #070a14, #0b1020 55%, #070a14);
      min-height:100vh;
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 16px 32px;
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 14px;
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border-radius: 20px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 5;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 240px;
    }
    .logo{
      width:40px; height:40px; border-radius: 14px;
      background:
        linear-gradient(135deg, rgba(124,92,255,.95), rgba(46,230,214,.85));
      display:grid; place-items:center;
      box-shadow: 0 10px 30px rgba(124,92,255,.25);
      border: 1px solid rgba(255,255,255,.18);
    }
    .logo span{ font-weight:800; }
    .brand h1{
      font-size: 15px;
      margin: 0;
      line-height: 1.15;
      letter-spacing: .2px;
    }
    .brand .sub{
      display:block;
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
      margin-top: 2px;
    }

    .top-actions{
      display:flex; align-items:center; gap:10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width: auto; }
      .topbar{ position: static; }
    }

    /* Panels */
    .card{
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2{
      margin: 0 0 10px 0;
      font-size: 14px;
      letter-spacing: .2px;
      color: rgba(255,255,255,.88);
      display:flex; align-items:center; gap:8px;
    }
    .muted{ color: var(--muted); font-size: 12.5px; line-height: 1.35; }

    /* Inputs */
    .row{ display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    label{ font-size: 12.5px; color: var(--muted); }
    input[type="file"]{
      width: 100%;
      padding: 10px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.25);
      background: rgba(0,0,0,.20);
      color: var(--muted);
    }
    select, input[type="text"]{
      width: 100%;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline: none;
    }
    select:focus, input[type="text"]:focus{
      border-color: rgba(124,92,255,.55);
      box-shadow: 0 0 0 4px rgba(124,92,255,.18);
    }

    /* Buttons */
    button{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding: 11px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    button:hover{ background: rgba(255,255,255,.12); }
    button:active{ transform: translateY(1px); }
    button:disabled{
      opacity: .45;
      cursor: not-allowed;
      transform:none;
    }

    .btn-primary{
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(124,92,255,.65));
      border-color: rgba(124,92,255,.55);
    }
    .btn-primary:hover{ background: linear-gradient(135deg, rgba(124,92,255,1), rgba(124,92,255,.72)); }

    .btn-ghost{
      background: rgba(255,255,255,.06);
    }

    .pill{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }
    .kpi{
      display:flex; gap:10px; flex-wrap: wrap;
      margin-top: 8px;
    }

    /* Quiz area */
    #quiz{ display:none; }
    .quiz-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    #meta{
      color: var(--muted);
      font-size: 12px;
    }
    #prompt{
      margin: 6px 0 0 0;
      font-size: 22px;
      letter-spacing: .2px;
      line-height: 1.15;
    }
    .prompt-box{
      padding: 14px;
      border-radius: 16px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.12);
    }
    .prompt-tools{
      display:flex; gap:10px; flex-wrap: wrap; align-items:center;
    }

    /* Choices */
    .choices{
      display:grid;
      gap: 10px;
      margin-top: 12px;
    }
    .choice{
      text-align:left;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      transition: background .15s ease, border-color .15s ease, transform .06s ease;
    }
    .choice:hover{ background: rgba(255,255,255,.10); }
    .choice:active{ transform: translateY(1px); }
    .choice.disabled{ cursor: default; opacity: .92; }
    .choice.correct{
      border-color: rgba(38,208,124,.55);
      background: rgba(38,208,124,.18);
    }
    .choice.wrong{
      border-color: rgba(255,77,109,.55);
      background: rgba(255,77,109,.18);
    }

    /* Feedback */
    #feedback{
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.12);
      min-height: 48px;
    }
    .ok{ color: var(--good); font-weight: 800; }
    .bad{ color: var(--bad); font-weight: 800; }
    .hint{ color: var(--muted); font-size: 12.5px; margin-top: 6px; }

    .divider{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 14px 0;
    }

    /* Bottom controls */
    .bottom-controls{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .bottom-controls .left, .bottom-controls .right{
      display:flex; gap:10px; flex-wrap: wrap; align-items:center;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.75);
    }

    /* Small helper blocks */
    .mini{
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- TOP BAR -->
    <div class="topbar">
      <div class="brand">
        <div class="logo"><span>Q</span></div>
        <div>
          <h1>English Quiz <span class="sub">Excel‚Äôden ‚Ä¢ EN‚ÜíTR ≈ûƒ±klƒ± / TR‚ÜíEN Yazmalƒ±</span></h1>
        </div>
      </div>

      <div class="top-actions">
        <span class="pill">Klavye: <span class="kbd">‚Üí</span> sonraki ‚Ä¢ <span class="kbd">1-4</span> ≈üƒ±k ‚Ä¢ <span class="kbd">Enter</span> kontrol</span>
        <span class="pill">Ses: EN‚ÜíTR‚Äôde otomatik</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Settings -->
      <div class="card">
        <h2>‚öôÔ∏è Ayarlar</h2>

        <div class="row" style="margin-bottom:10px">
          <input id="file" type="file" accept=".xlsx,.xls" />
        </div>

        <div class="row" style="margin-top:8px">
          <div style="flex:1; min-width: 160px;">
            <label>Mod</label>
            <select id="direction">
              <option value="EN_TR">English ‚Üí T√ºrk√ße</option>
              <option value="TR_EN">T√ºrk√ße ‚Üí English</option>
            </select>
          </div>

          <div style="flex:1; min-width: 160px;">
            <label>Soru tipi</label>
            <select id="qtype">
              <option value="MCQ">4 ≈ûƒ±klƒ±</option>
              <option value="TYPE">Yazmalƒ±</option>
              <option value="MIX">Karƒ±≈üƒ±k</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1; min-width: 160px;">
            <label>Quiz kaynaƒüƒ±</label>
            <select id="sourceMode">
              <option value="ALL">T√ºm sorular</option>
              <option value="WRONG_ONLY">‚ùå Sadece yanlƒ±≈ülar</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="muted">
          Excel‚Äôde ilk sayfada iki s√ºtun olmalƒ±:
          <b>English</b> / <b>Turkish</b> (ya da <b>ƒ∞ngilizce</b> / <b>T√ºrk√ße</b>).
        </div>

        <div class="divider"></div>

        <h2>üìä ƒ∞statistik</h2>
        <div class="kpi">
          <span class="pill"><b>Skor:</b>&nbsp;<span id="score">0</span>/<span id="total">0</span></span>
          <span class="pill">Yanlƒ±≈ü havuzu: <b id="wrongCount">0</b></span>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button id="start" class="btn-primary" disabled>Ba≈ülat</button>
          <button id="next" class="btn-ghost" disabled>Sonraki</button>
          <button id="reset" class="btn-ghost" disabled>Sƒ±fƒ±rla</button>
        </div>

        <div class="mini" style="margin-top:10px">
          ƒ∞pucu: ‚ÄúSadece yanlƒ±≈ülar‚Äù se√ßtiƒüinde havuz bo≈üsa √∂nce yanlƒ±≈ü yapman gerekir üôÇ
        </div>
      </div>

      <!-- RIGHT: Quiz -->
      <div class="card" id="quiz" style="display:none">
        <div class="quiz-head">
          <div class="muted" id="meta"></div>
          <div class="prompt-tools">
            <button id="speakBtn" class="btn-ghost" type="button">üîä Tekrar</button>
          </div>
        </div>

        <div class="prompt-box">
          <h3 id="prompt"></h3>
        </div>

        <div id="mcq" style="display:none">
          <div class="choices" id="choices"></div>
        </div>

        <div id="typing" style="display:none; margin-top:12px">
          <input id="answerInput" type="text" placeholder="Cevabƒ±nƒ± yaz..." autocomplete="off" />
          <div class="row" style="margin-top:10px">
            <button id="check" class="btn-primary">Kontrol Et</button>
            <button id="show" class="btn-ghost">Cevabƒ± G√∂ster</button>
          </div>
        </div>

        <div id="feedback"></div>

        <div class="divider"></div>

        <div class="bottom-controls">
          <div class="left">
            <span class="pill">Kƒ±sayollar:
              <span class="kbd">‚Üí</span> sonraki ‚Ä¢
              <span class="kbd">R</span> tekrar oku ‚Ä¢
              <span class="kbd">Esc</span> sƒ±fƒ±rla
            </span>
          </div>
          <div class="right">
            <span class="pill">≈ûƒ±klƒ± mod: <span class="kbd">1</span><span class="kbd">2</span><span class="kbd">3</span><span class="kbd">4</span></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // -------- State --------
    let pairs = [];           // [{en,tr}]
    let wrongIds = new Set(); // unique wrong pool (by id)
    let wrongList = [];       // [{id,en,tr}]
    let current = null;       // {id, prompt, answer, qtype, en, tr}
    let score = 0;
    let total = 0;
    let lastMCQButtons = [];  // current choices buttons cache
>>>>>>> d08d4c9 (updete-theme)

    const el = (id) => document.getElementById(id);

    function normalize(s) {
      return (s ?? "").toString().trim().replace(/\s+/g, " ").toLowerCase();
    }

    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

<<<<<<< HEAD
    // -------- Speech (EN‚ÜíTR ≈üƒ±klƒ± sorularda ƒ∞ngilizce prompt okunur) --------
    let cachedVoices = [];
    function loadVoices() {
      if (!("speechSynthesis" in window)) return;
      cachedVoices = window.speechSynthesis.getVoices() || [];
    }
    if ("speechSynthesis" in window) {
      loadVoices();
      window.speechSynthesis.onvoiceschanged = () => loadVoices();
    }
    function pickNiceEnglishVoice() {
      const v = cachedVoices || [];
      return v.find(x => (x.lang || "").toLowerCase() === "en-gb")
          || v.find(x => (x.lang || "").toLowerCase().startsWith("en-"))
          || v.find(x => (x.lang || "").toLowerCase().startsWith("en"))
          || null;
    }
    function speakEnglish(text) {
      if (!text) return;
      if (!("speechSynthesis" in window)) return;

      const utter = new SpeechSynthesisUtterance(text);
      const voice = pickNiceEnglishVoice();
      if (voice) utter.voice = voice;

      utter.lang = (voice?.lang) || "en-GB";
      utter.rate = 0.85;
      utter.pitch = 1.0;
      utter.volume = 1;

      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

=======
>>>>>>> d08d4c9 (updete-theme)
    function updateStats() {
      el("score").textContent = String(score);
      el("total").textContent = String(total);
      el("wrongCount").textContent = String(wrongList.length);
<<<<<<< HEAD
      el("poolLabel").textContent = (el("sourceMode").value === "WRONG_ONLY") ? "Yanlƒ±≈ülar" : "T√ºm sorular";
      const mode = el("direction").value;
      el("modeLabel").textContent = (mode === "EN_TR") ? "EN‚ÜíTR" : "TR‚ÜíEN";
=======
>>>>>>> d08d4c9 (updete-theme)
    }

    function setFeedback(html) {
      el("feedback").innerHTML = html;
    }

    function showQuizUI(show) {
      el("quiz").style.display = show ? "block" : "none";
    }

<<<<<<< HEAD
=======
    function decideQType(selected) {
      if (selected === "MIX") return Math.random() < 0.5 ? "MCQ" : "TYPE";
      return selected;
    }

>>>>>>> d08d4c9 (updete-theme)
    function makeId(en, tr) {
      return normalize(en) + "||" + normalize(tr);
    }

    function getPool() {
<<<<<<< HEAD
      if (el("sourceMode").value === "WRONG_ONLY") return wrongList;
      return pairs.map(p => ({ ...p, id: makeId(p.en, p.tr) }));
    }

    function getQA(item, mode) {
      if (mode === "EN_TR") return { prompt: item.en, answer: item.tr };
      return { prompt: item.tr, answer: item.en };
    }

    function buildMCQ(correctAnswer, correctId) {
=======
      const mode = el("sourceMode").value;
      if (mode === "WRONG_ONLY") return wrongList;
      return pairs.map(p => ({...p, id: makeId(p.en, p.tr)}));
    }

    function getQA(item, direction) {
      if (direction === "EN_TR") return { prompt: item.en, answer: item.tr };
      return { prompt: item.tr, answer: item.en };
    }

    function buildMCQ(correctAnswer, direction, correctId) {
>>>>>>> d08d4c9 (updete-theme)
      const options = [correctAnswer];
      const used = new Set([normalize(correctAnswer)]);

      let tries = 0;
      while (options.length < 4 && tries < 2000) {
        tries++;
        const p = pairs[Math.floor(Math.random() * pairs.length)];
        const id = makeId(p.en, p.tr);
        if (id === correctId) continue;

<<<<<<< HEAD
        const ans = p.tr; // EN_TR i√ßin yanlƒ±≈ülar T√ºrk√ße
        const key = normalize(ans);
        if (!key || used.has(key)) continue;

=======
        const qa = getQA({ ...p, id }, direction);
        const ans = qa.answer;
        const key = normalize(ans);
        if (!key || used.has(key)) continue;
>>>>>>> d08d4c9 (updete-theme)
        used.add(key);
        options.push(ans);
      }
      return shuffle(options).slice(0, 4);
    }

    function markWrongById(id, en, tr) {
      if (wrongIds.has(id)) return;
      wrongIds.add(id);
      wrongList.push({ id, en, tr });
<<<<<<< HEAD
      updateStats();
    }

    function clearChoiceStyles() {
      const btns = document.querySelectorAll("#choices .choice");
      btns.forEach(b => {
        b.classList.remove("correct", "wrong");
        b.disabled = false;
      });
    }

    function highlightMCQ(selectedText) {
      const btns = document.querySelectorAll("#choices .choice");
      const sel = normalize(selectedText);
      const correct = normalize(current.answer);

      btns.forEach(b => {
        const t = normalize(b.textContent);
        if (t === correct) b.classList.add("correct");
        if (t === sel && sel !== correct) b.classList.add("wrong");
        b.disabled = true;
      });
    }

    function buildDiff(user, correct) {
      const u = (user ?? "").toString();
      const c = (correct ?? "").toString();

      const max = Math.max(u.length, c.length);
      let userHtml = "";
      let corrHtml = "";

      for (let i = 0; i < max; i++) {
        const uc = u[i];
        const cc = c[i];

        if (uc !== undefined && cc !== undefined && uc.toLowerCase() === cc.toLowerCase()) {
          const chU = uc === " " ? `<span class="spaceChar">&nbsp;</span>` : uc;
          const chC = cc === " " ? `<span class="spaceChar">&nbsp;</span>` : cc;
          userHtml += `<span class="goodChar">${chU}</span>`;
          corrHtml += `<span class="goodChar">${chC}</span>`;
          continue;
        }

        if (uc !== undefined && cc === undefined) {
          const chU = uc === " " ? `<span class="spaceChar">&nbsp;</span>` : uc;
          userHtml += `<span class="badChar">${chU}</span>`;
          continue;
        }

        if (uc === undefined && cc !== undefined) {
          const chC = cc === " " ? `<span class="spaceChar">&nbsp;</span>` : cc;
          corrHtml += `<span class="missChar">${chC}</span>`;
          continue;
        }

        if (uc !== undefined && cc !== undefined) {
          const chU = uc === " " ? `<span class="spaceChar">&nbsp;</span>` : uc;
          const chC = cc === " " ? `<span class="spaceChar">&nbsp;</span>` : cc;
          userHtml += `<span class="badChar">${chU}</span>`;
          corrHtml += `<span class="badChar">${chC}</span>`;
        }
      }

      return `
        <div class="muted" style="margin-top:10px">Senin yazdƒ±ƒüƒ±n:</div>
        <div class="diffline">${userHtml || "<span class='muted'>(bo≈ü)</span>"}</div>
        <div class="muted" style="margin-top:10px">Doƒüru cevap:</div>
        <div class="diffline">${corrHtml || correct}</div>
      `;
    }

=======
    }

    // -------- Speech (EN only prompt) --------
    let cachedVoices = [];
    function loadVoices() {
      try { cachedVoices = window.speechSynthesis?.getVoices?.() || []; }
      catch { cachedVoices = []; }
    }
    if ("speechSynthesis" in window) {
      loadVoices();
      window.speechSynthesis.onvoiceschanged = () => loadVoices();
    }

    function pickEnglishVoice() {
      const v = cachedVoices || [];
      const prefer = ["en-GB", "en-US", "en"];
      for (const p of prefer) {
        const found = v.find(x => (x.lang || "").toLowerCase() === p.toLowerCase());
        if (found) return found;
      }
      return v.find(x => (x.lang || "").toLowerCase().startsWith("en-")) || null;
    }

    function speakEnglish(text) {
      if (!text) return;
      if (!("speechSynthesis" in window)) return;

      // only speak when mode is EN_TR (prompt is English)
      const direction = el("direction").value;
      if (direction !== "EN_TR") return;

      try {
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        const voice = pickEnglishVoice();
        if (voice) utter.voice = voice;
        utter.lang = voice?.lang || "en-GB";
        utter.rate = 0.9;
        utter.pitch = 1.0;
        utter.volume = 1;
        window.speechSynthesis.speak(utter);
      } catch (e) {
        // ignore
      }
    }

    // -------- Render --------
>>>>>>> d08d4c9 (updete-theme)
    function renderQuestion() {
      if (!current) return;

      showQuizUI(true);
      el("prompt").textContent = current.prompt;
<<<<<<< HEAD
      setFeedback("");

      const isENTR = current.mode === "EN_TR";
      el("mcq").style.display = isENTR ? "block" : "none";
      el("typing").style.display = isENTR ? "none" : "block";
      el("meta").textContent = isENTR ? "EN‚ÜíTR: ≈ûƒ±klƒ± (+ Ses)" : "TR‚ÜíEN: Yazmalƒ± (hata g√∂sterir)";

      if (isENTR) {
        const opts = buildMCQ(current.answer, current.id);
        const container = el("choices");
        container.innerHTML = "";
        opts.forEach(opt => {
          const btn = document.createElement("button");
          btn.className = "choice";
          btn.textContent = opt;
          btn.onclick = () => checkMCQ(opt);
          container.appendChild(btn);
        });
        clearChoiceStyles();

        // ‚úÖ SES: ≈ûƒ±klƒ± (EN‚ÜíTR) soruda ƒ∞ngilizce prompt'u otomatik oku
        speakEnglish(current.prompt);
=======
      el("meta").textContent = `Soru tipi: ${current.qtype === "MCQ" ? "4 ≈ûƒ±klƒ±" : "Yazmalƒ±"}`;
      setFeedback("");
      lastMCQButtons = [];

      el("mcq").style.display = current.qtype === "MCQ" ? "block" : "none";
      el("typing").style.display = current.qtype === "TYPE" ? "block" : "none";

      if (current.qtype === "MCQ") {
        const direction = el("direction").value;
        const opts = buildMCQ(current.answer, direction, current.id);

        const container = el("choices");
        container.innerHTML = "";
        opts.forEach((opt, idx) => {
          const btn = document.createElement("button");
          btn.className = "choice";
          btn.textContent = opt;
          btn.setAttribute("data-index", String(idx + 1));
          btn.onclick = () => checkMCQ(opt, btn);
          container.appendChild(btn);
          lastMCQButtons.push(btn);
        });
>>>>>>> d08d4c9 (updete-theme)
      } else {
        el("answerInput").value = "";
        el("answerInput").focus();
      }

<<<<<<< HEAD
      updateStats();
=======
      // Speak (EN only)
      speakEnglish(current.prompt);
>>>>>>> d08d4c9 (updete-theme)
    }

    function nextQuestion() {
      const pool = getPool();
      if (!pool.length) {
        alert("Bu modda soru yok. (Sadece yanlƒ±≈ülar se√ßiliyse √∂nce yanlƒ±≈ü yapman lazƒ±m üòÑ)");
        return;
      }

<<<<<<< HEAD
      const item = pool[Math.floor(Math.random() * pool.length)];
      const mode = el("direction").value; // kullanƒ±cƒ± se√ßiyor
      const qa = getQA(item, mode);
=======
      const direction = el("direction").value;
      const qtypeSelected = el("qtype").value;

      // Requirement: EN_TR can be MCQ; TR_EN can be TYPE if user selects MIX etc.
      // We keep user selection but make it predictable:
      // If direction is TR_EN and user selected MCQ, we still allow MCQ (user choice),
      // but your preference earlier was TR_EN = TYPE. If you want strict behavior, tell me.
      const qtype = decideQType(qtypeSelected);

      const item = pool[Math.floor(Math.random() * pool.length)];
      const qa = getQA(item, direction);
>>>>>>> d08d4c9 (updete-theme)

      current = {
        id: item.id ?? makeId(item.en, item.tr),
        en: item.en,
        tr: item.tr,
<<<<<<< HEAD
        mode,
        prompt: qa.prompt,
        answer: qa.answer
=======
        prompt: qa.prompt,
        answer: qa.answer,
        qtype
>>>>>>> d08d4c9 (updete-theme)
      };

      renderQuestion();
    }

<<<<<<< HEAD
    function checkMCQ(selected) {
      total++;
      const ok = normalize(selected) === normalize(current.answer);

      highlightMCQ(selected);
=======
    function lockMCQButtons() {
      lastMCQButtons.forEach(b => {
        b.classList.add("disabled");
        b.disabled = true;
      });
    }

    function colorMCQ(selectedBtn, ok) {
      // highlight chosen + correct answer
      const correctText = normalize(current.answer);

      lastMCQButtons.forEach(b => {
        const isCorrect = normalize(b.textContent) === correctText;
        if (isCorrect) b.classList.add("correct");
      });

      if (!ok && selectedBtn) {
        selectedBtn.classList.add("wrong");
      }
      if (ok && selectedBtn) {
        selectedBtn.classList.add("correct");
      }
    }

    function checkMCQ(selected, btnRef) {
      total++;
      const ok = normalize(selected) === normalize(current.answer);

      lockMCQButtons();
      colorMCQ(btnRef, ok);
>>>>>>> d08d4c9 (updete-theme)

      if (ok) {
        score++;
        setFeedback(`<div class="ok">‚úÖ Doƒüru</div>`);
      } else {
        markWrongById(current.id, current.en, current.tr);
<<<<<<< HEAD
        setFeedback(`<div class="bad">‚ùå Yanlƒ±≈ü</div><div class="muted">Doƒüru cevap: <b>${current.answer}</b></div>`);
=======
        setFeedback(`<div class="bad">‚ùå Yanlƒ±≈ü</div><div class="hint">Doƒüru cevap: <b>${current.answer}</b></div>`);
>>>>>>> d08d4c9 (updete-theme)
      }
      updateStats();
    }

    function checkTyping() {
      total++;
      const typed = el("answerInput").value;
      const ok = normalize(typed) === normalize(current.answer);

      if (ok) {
        score++;
        setFeedback(`<div class="ok">‚úÖ Doƒüru</div>`);
      } else {
        markWrongById(current.id, current.en, current.tr);
<<<<<<< HEAD
        setFeedback(`<div class="bad">‚ùå Yanlƒ±≈ü</div>${buildDiff(typed, current.answer)}`);
=======

        // "Nerede yanlƒ±≈ü yazdƒ±ƒüƒ±mƒ± g√∂ster" ‚Üí basit fark vurgusu
        const a = (typed ?? "").toString();
        const b = (current.answer ?? "").toString();
        const diff = highlightDiff(a, b);

        setFeedback(
          `<div class="bad">‚ùå Yanlƒ±≈ü</div>
           <div class="hint">Senin cevap: ${diff.user}</div>
           <div class="hint">Doƒüru: <b>${diff.correct}</b></div>`
        );
>>>>>>> d08d4c9 (updete-theme)
      }
      updateStats();
    }

<<<<<<< HEAD
    function showAnswer() {
      if (!current) return;
      if (current.mode === "EN_TR") {
        setFeedback(`<div class="muted">Doƒüru cevap: <b>${current.answer}</b></div>`);
        highlightMCQ(current.answer);
      } else {
        const typed = el("answerInput").value;
        setFeedback(`<div class="muted">Doƒüru cevap: <b>${current.answer}</b></div>${buildDiff(typed, current.answer)}`);
      }
=======
    function highlightDiff(user, correct) {
      // simple character-level highlight (first mismatch onwards)
      const u = user;
      const c = correct;
      let i = 0;
      const min = Math.min(u.length, c.length);
      while (i < min && u[i].toLowerCase() === c[i].toLowerCase()) i++;

      const safe = (s) => s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
      const before = safe(u.slice(0, i));
      const wrongPart = safe(u.slice(i));
      const userHtml = wrongPart ? `${before}<span style="color: var(--bad); font-weight:800;">${wrongPart}</span>` : safe(u);

      return {
        user: `<code style="background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.12);">${userHtml || "<i>(bo≈ü)</i>"}</code>`,
        correct: safe(c)
      };
    }

    function showAnswer() {
      setFeedback(`<div class="hint">Cevap: <b>${current?.answer ?? ""}</b></div>`);
>>>>>>> d08d4c9 (updete-theme)
    }

    function resetAll() {
      current = null;
      score = 0;
      total = 0;
      wrongIds = new Set();
      wrongList = [];
      updateStats();
      setFeedback("");
      showQuizUI(false);

      el("start").disabled = pairs.length < 4;
      el("next").disabled = true;
      el("reset").disabled = pairs.length < 4;
    }

<<<<<<< HEAD
    // yanlƒ±≈ülar moduna ge√ßince
    el("sourceMode").addEventListener("change", () => {
      updateStats();
      if (el("sourceMode").value === "WRONG_ONLY") {
        if (wrongList.length === 0) {
          alert("Hen√ºz yanlƒ±≈ü havuzun bo≈ü. √ñnce birka√ß soru yanlƒ±≈ü yap üòÑ");
          return;
        }
        el("next").disabled = false;
        nextQuestion();
      }
    });

    // Mod deƒüi≈üince: yeni soru getir
    el("direction").addEventListener("change", () => {
      updateStats();
      if (current) nextQuestion();
    });

=======
>>>>>>> d08d4c9 (updete-theme)
    // ---------- Excel Load ----------
    el("file").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type: "array" });

      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

      function findKey(obj, candidates) {
        const keys = Object.keys(obj);
        for (const k of keys) {
          const nk = normalize(k);
          if (candidates.includes(nk)) return k;
        }
        return null;
      }

      const mapped = [];
      for (const r of rows) {
        const enKey = findKey(r, ["english", "ingilizce"]);
        const trKey = findKey(r, ["turkish", "t√ºrk√ße", "turkce"]);
        if (!enKey || !trKey) continue;

        const en = (r[enKey] ?? "").toString().trim();
        const tr = (r[trKey] ?? "").toString().trim();
        if (en && tr) mapped.push({ en, tr });
      }

      pairs = mapped;

      if (pairs.length < 4) {
        alert("Excel okundu ama en az 4 satƒ±r lazƒ±m (English + Turkish dolu).");
        pairs = [];
        resetAll();
        return;
      }

      showQuizUI(true);
      score = 0; total = 0;
      wrongIds = new Set();
      wrongList = [];
      updateStats();
      setFeedback("");

      el("start").disabled = false;
      el("next").disabled = true;
      el("reset").disabled = false;

      alert(`Y√ºklendi ‚úÖ Toplam kart: ${pairs.length}\n≈ûimdi 'Ba≈ülat'a bas.`);
    });

    // ---------- Buttons ----------
    el("start").addEventListener("click", () => {
      el("next").disabled = false;
      nextQuestion();
    });
<<<<<<< HEAD
    el("next").addEventListener("click", () => nextQuestion());
    el("reset").addEventListener("click", () => resetAll());

    el("check").addEventListener("click", () => checkTyping());
    el("show").addEventListener("click", () => showAnswer());

    // Enter = yazmalƒ± kontrol (Space serbest!)
    el("answerInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") checkTyping();
    });

    // ‚å®Ô∏è Klavye (Space tek ba≈üƒ±na artƒ±k YOK)
    document.addEventListener("keydown", (e) => {
      if (!current) return;

      // ‚Üí = sonraki
      if (e.key === "ArrowRight") { e.preventDefault(); nextQuestion(); return; }

      // ‚Üì = cevap g√∂ster (Space yerine)
      if (e.key === "ArrowDown") { e.preventDefault(); showAnswer(); return; }

      // Ctrl+Space = cevap g√∂ster (opsiyonel)
      if (e.ctrlKey && e.key === " ") { e.preventDefault(); showAnswer(); return; }

      // EN‚ÜíTR ise 1-4 ≈üƒ±k
      if (current.mode === "EN_TR") {
        const buttons = document.querySelectorAll("#choices .choice");
        if (e.key === "1" && buttons[0]) { buttons[0].click(); return; }
        if (e.key === "2" && buttons[1]) { buttons[1].click(); return; }
        if (e.key === "3" && buttons[2]) { buttons[2].click(); return; }
        if (e.key === "4" && buttons[3]) { buttons[3].click(); return; }
      }
    });

    updateStats();
=======

    el("next").addEventListener("click", () => nextQuestion());
    el("reset").addEventListener("click", () => resetAll());
    el("check").addEventListener("click", () => checkTyping());
    el("show").addEventListener("click", () => showAnswer());
    el("speakBtn").addEventListener("click", () => {
      if (current) speakEnglish(current.prompt);
    });

    // Enter to check in typing (already), but DO NOT use space to show answer.
    el("answerInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") checkTyping();
      // space is allowed for typing; no special action here
    });

    // ---------- Global keyboard shortcuts ----------
    document.addEventListener("keydown", (e) => {
      // avoid interfering when user is typing in input
      const isTyping = document.activeElement === el("answerInput");

      // ESC = reset
      if (e.key === "Escape") {
        e.preventDefault();
        resetAll();
        return;
      }

      // R = repeat speech
      if ((e.key === "r" || e.key === "R") && !isTyping) {
        if (current) speakEnglish(current.prompt);
        return;
      }

      // ArrowRight = next question
      if (e.key === "ArrowRight") {
        if (!el("next").disabled) {
          e.preventDefault();
          nextQuestion();
        }
        return;
      }

      // MCQ: 1-4 choose options
      if (!isTyping && current && current.qtype === "MCQ") {
        const n = Number(e.key);
        if (n >= 1 && n <= 4) {
          const btn = lastMCQButtons[n - 1];
          if (btn && !btn.disabled) {
            e.preventDefault();
            btn.click();
          }
        }
      }
    });
>>>>>>> d08d4c9 (updete-theme)
  </script>
</body>
</html>
